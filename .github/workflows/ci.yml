name: ci

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize, reopened ]
  workflow_dispatch: {}

permissions:
  contents: read
  security-events: write
  checks: write

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  PNPM_VERSION: '8.15.5'
  DEPLOY_ENABLED: 'false'

jobs:
  fast-check:
    name: Fast checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install deps (fast)
        run: |
          pnpm install --frozen-lockfile --ignore-scripts || npm ci --no-audit --no-fund

      - name: Typecheck
        run: pnpm run typecheck || echo "Typecheck skipped"

      - name: Lint
        run: pnpm run lint --max-warnings 0 || echo "Lint skipped"

  quality:
    name: Quality & Tests
    runs-on: ubuntu-latest
    needs: fast-check
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install deps
        run: pnpm install --frozen-lockfile || npm ci --no-audit --no-fund

      - name: Build
        run: pnpm run build --if-present || echo "No build step"

      - name: Run tests
        run: pnpm run test --if-present || echo "No tests or tests failed"

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [fast-check, quality]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "Fast: ${{ needs.fast-check.result }}"
          echo "Quality: ${{ needs.quality.result }}"
          echo "Node: ${{ env.NODE_VERSION }}"
          echo "Deploy Enabled: ${{ env.DEPLOY_ENABLED }}"
